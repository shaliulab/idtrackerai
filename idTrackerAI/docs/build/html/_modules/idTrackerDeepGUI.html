<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>idTrackerDeepGUI &mdash; idtrackerai v0.0 Manual</title>
    
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../_static/scipy.css" type="text/css" >
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/copybutton.js"></script>
    <link rel="index" title="Index" href="../genindex.html" >
    <link rel="search" title="Search" href="../search.html" >
    <link rel="top" title="idtrackerai v0.0 Manual" href="../index.html" >
    <link rel="up" title="Module code" href="index.html" > 
  </head>
  <body>

<div class="container">
  <div class="top-scipy-org-logo-header">
    <a href="../index.html">
      <img style="border: 0;" alt="idtrackerai" src="../_static/img/idtracker_logo.gif"></a>
    </div>
  </div>
</div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
        <li class="active"><a href="http://www.gitlab.com/polaviejalab/idtracker">GitLab repo</a></li>
	
        <li class="active"><a href="../index.html">idtrackerai v0.0 Manual</a></li>
	
          <li class="active"><a href="index.html" accesskey="U">Module code</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  <h1>Source code for idTrackerDeepGUI</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="c1"># Import standard libraries</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">isdir</span><span class="p">,</span> <span class="n">isfile</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1"># Import third party libraries</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">logging.config</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="c1"># Import application/library specifics</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./utils&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./preprocessing&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./postprocessing&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./network&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./network/crossings_detector_model&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./network/identification_model&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./groundtruth_utils&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./tf_cnnvis&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./plots&#39;</span><span class="p">)</span>
<span class="c1">#import from idTrackerai</span>
<span class="kn">from</span> <span class="nn">video</span> <span class="k">import</span> <span class="n">Video</span>
<span class="kn">from</span> <span class="nn">list_of_blobs</span> <span class="k">import</span> <span class="n">ListOfBlobs</span>
<span class="kn">from</span> <span class="nn">list_of_fragments</span> <span class="k">import</span> <span class="n">ListOfFragments</span><span class="p">,</span> <span class="n">create_list_of_fragments</span>
<span class="kn">from</span> <span class="nn">list_of_global_fragments</span> <span class="k">import</span> <span class="n">ListOfGlobalFragments</span><span class="p">,</span>\
                                        <span class="n">create_list_of_global_fragments</span>
<span class="kn">from</span> <span class="nn">global_fragments_statistics</span> <span class="k">import</span> <span class="n">compute_and_plot_fragments_statistics</span>
<span class="kn">from</span> <span class="nn">segmentation</span> <span class="k">import</span> <span class="n">segment</span><span class="p">,</span> <span class="n">resegment</span>
<span class="kn">from</span> <span class="nn">erosion</span> <span class="k">import</span> <span class="n">compute_erosion_disk</span>
<span class="kn">from</span> <span class="nn">GUI_utils</span> <span class="k">import</span> <span class="n">selectFile</span><span class="p">,</span> <span class="n">getInput</span><span class="p">,</span> <span class="n">selectOptions</span><span class="p">,</span> <span class="n">ROISelectorPreview</span><span class="p">,</span>\
                    <span class="n">resegmentation_preview</span><span class="p">,</span> <span class="n">selectPreprocParams</span><span class="p">,</span> <span class="n">selectDir</span><span class="p">,</span> \
                    <span class="n">check_resolution_reduction</span>
<span class="kn">from</span> <span class="nn">py_utils</span> <span class="k">import</span> <span class="n">getExistentFiles</span>
<span class="kn">from</span> <span class="nn">video_utils</span> <span class="k">import</span> <span class="n">checkBkg</span>
<span class="kn">from</span> <span class="nn">crossing_detector</span> <span class="k">import</span> <span class="n">detect_crossings</span>
<span class="kn">from</span> <span class="nn">pre_trainer</span> <span class="k">import</span> <span class="n">pre_trainer</span>
<span class="kn">from</span> <span class="nn">accumulation_manager</span> <span class="k">import</span> <span class="n">AccumulationManager</span>
<span class="kn">from</span> <span class="nn">accumulator</span> <span class="k">import</span> <span class="n">accumulate</span>
<span class="kn">from</span> <span class="nn">network_params</span> <span class="k">import</span> <span class="n">NetworkParams</span>
<span class="kn">from</span> <span class="nn">trainer</span> <span class="k">import</span> <span class="n">train</span>
<span class="kn">from</span> <span class="nn">assigner</span> <span class="k">import</span> <span class="n">assigner</span>
<span class="kn">from</span> <span class="nn">visualize_embeddings</span> <span class="k">import</span> <span class="n">visualize_embeddings_global_fragments</span>
<span class="kn">from</span> <span class="nn">id_CNN</span> <span class="k">import</span> <span class="n">ConvNetwork</span>
<span class="kn">from</span> <span class="nn">correct_duplications</span> <span class="k">import</span> <span class="n">solve_duplications</span><span class="p">,</span>\
                                    <span class="n">mark_fragments_as_duplications</span>
<span class="kn">from</span> <span class="nn">correct_impossible_velocity_jumps</span> <span class="k">import</span> <span class="n">correct_impossible_velocity_jumps</span>
<span class="kn">from</span> <span class="nn">get_trajectories</span> <span class="k">import</span> <span class="n">produce_output_dict</span>
<span class="kn">from</span> <span class="nn">generate_groundtruth</span> <span class="k">import</span> <span class="n">GroundTruth</span><span class="p">,</span> <span class="n">GroundTruthBlob</span>
<span class="kn">from</span> <span class="nn">compute_groundtruth_statistics</span> <span class="k">import</span> <span class="n">get_accuracy_wrt_groundtruth</span>
<span class="kn">from</span> <span class="nn">compute_velocity_model</span> <span class="k">import</span> <span class="n">compute_model_velocity</span>
<span class="kn">from</span> <span class="nn">assign_them_all</span> <span class="k">import</span> <span class="n">close_trajectories_gaps</span>
<span class="c1"># from visualise_cnn import visualise</span>

<span class="kn">from</span> <span class="nn">constants</span> <span class="k">import</span> <span class="n">THRESHOLD_ACCEPTABLE_ACCUMULATION</span><span class="p">,</span> <span class="n">VEL_PERCENTILE</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="setup_logging"><a class="viewcode-back" href="../index.html#idTrackerDeepGUI.setup_logging">[docs]</a><span class="k">def</span> <span class="nf">setup_logging</span><span class="p">(</span>
    <span class="n">default_path</span><span class="o">=</span><span class="s1">&#39;logging.yaml&#39;</span><span class="p">,</span>
    <span class="n">default_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="n">env_key</span><span class="o">=</span><span class="s1">&#39;LOG_CFG&#39;</span><span class="p">,</span>
    <span class="n">path_to_save_logs</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span><span class="p">,</span>
    <span class="n">video_object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Setup logging configuration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">default_path</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">env_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_save_logs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">video_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">video_object</span><span class="o">.</span><span class="n">logs_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save_logs</span><span class="p">,</span> <span class="s1">&#39;log_files&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">video_object</span><span class="o">.</span><span class="n">logs_folder</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">video_object</span><span class="o">.</span><span class="n">logs_folder</span><span class="p">)</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;handlers&#39;</span><span class="p">][</span><span class="s1">&#39;info_file_handler&#39;</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">video_object</span><span class="o">.</span><span class="n">logs_folder</span><span class="p">,</span> <span class="s1">&#39;info.log&#39;</span><span class="p">)</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;handlers&#39;</span><span class="p">][</span><span class="s1">&#39;error_file_handler&#39;</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">video_object</span><span class="o">.</span><span class="n">logs_folder</span><span class="p">,</span> <span class="s1">&#39;error.log&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">default_level</span><span class="p">)</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logger</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Bars&#39;</span><span class="p">)</span> <span class="c1">#FIXME If we do not create the &quot;Bars&quot; window here we have the &quot;Bad window error&quot;...</span>
    <span class="n">video_path</span> <span class="o">=</span> <span class="n">selectFile</span><span class="p">()</span> <span class="c1">#select path to video</span>
    <span class="n">video</span> <span class="o">=</span> <span class="n">Video</span><span class="p">()</span> <span class="c1">#instantiate object video</span>
    <span class="n">video</span><span class="o">.</span><span class="n">video_path</span> <span class="o">=</span> <span class="n">video_path</span> <span class="c1">#set path</span>
    <span class="n">new_name_session_folder</span> <span class="o">=</span> <span class="n">getInput</span><span class="p">(</span><span class="s1">&#39;Session name, &#39;</span><span class="p">,</span> <span class="s1">&#39;Input session name. Use an old session name to load and overwrite files&#39;</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">create_session_folder</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name_session_folder</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">init_processes_time_attributes</span><span class="p">()</span>
    <span class="c1"># set log config</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">(</span><span class="n">path_to_save_logs</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">session_folder</span><span class="p">,</span> <span class="n">video_object</span> <span class="o">=</span> <span class="n">video</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting working on session </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">new_name_session_folder</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Log files saved in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">video</span><span class="o">.</span><span class="n">logs_folder</span><span class="p">)</span>
    <span class="c1">#Asking user whether to reuse preprocessing steps...&#39;</span>
    <span class="n">processes_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;preprocessing&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;use_previous_knowledge_transfer_decision&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;first_accumulation&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;pretraining&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;second_accumulation&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;assignment&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;solving_duplications&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;crossings&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;trajectories&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;trajectories_wo_gaps&#39;</span><span class="p">]</span>
    <span class="c1">#get existent files and paths to load them</span>
    <span class="n">existentFiles</span><span class="p">,</span> <span class="n">old_video</span> <span class="o">=</span> <span class="n">getExistentFiles</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">processes_list</span><span class="p">)</span>
    <span class="c1">#selecting files to load from previous session...&#39;</span>
    <span class="n">loadPreviousDict</span> <span class="o">=</span> <span class="n">selectOptions</span><span class="p">(</span><span class="n">processes_list</span><span class="p">,</span> <span class="n">existentFiles</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Steps already processed in this video </span><span class="se">\n</span><span class="s1"> (loaded from &#39;</span> <span class="o">+</span> <span class="n">video</span><span class="o">.</span><span class="n">video_folder</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
    <span class="c1">#use previous values and parameters (bkg, roi, preprocessing parameters)?</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Video session folder: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span><span class="n">video</span><span class="o">.</span><span class="n">session_folder</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="c1"># try:</span>
    <span class="c1">#############################################################</span>
    <span class="c1">##################   Knowledge transfer  ####################</span>
    <span class="c1">####   Take the weights from a different model already   ####</span>
    <span class="c1">####   trained. Works better when transfering to similar ####</span>
    <span class="c1">####   conditions (light, animal type, age, ...)         ####</span>
    <span class="c1">#############################################################</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;use_previous_knowledge_transfer_decision&#39;</span><span class="p">]):</span>
        <span class="n">knowledge_transfer_flag</span> <span class="o">=</span> <span class="n">getInput</span><span class="p">(</span><span class="s1">&#39;Knowledge transfer&#39;</span><span class="p">,</span><span class="s1">&#39;Do you want to perform knowledge transfer from another model? [y]/n&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">knowledge_transfer_flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span> <span class="ow">or</span> <span class="n">knowledge_transfer_flag</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">video</span><span class="o">.</span><span class="n">knowledge_transfer_model_folder</span> <span class="o">=</span> <span class="n">selectDir</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Select a session folder to perform knowledge transfer from the last accumulation point&quot;</span><span class="p">)</span> <span class="c1">#select path to video</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_tracking_with_knowledge_transfer</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">video</span><span class="o">.</span><span class="n">knowledge_transfer_info_dict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">knowledge_transfer_model_folder</span><span class="p">,</span> <span class="s1">&#39;info.npy&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">same_animals</span> <span class="o">=</span> <span class="n">getInput</span><span class="p">(</span><span class="s2">&quot;Same animals&quot;</span><span class="p">,</span> <span class="s2">&quot;Are you tracking the same animals? y/N&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">same_animals</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">video</span><span class="o">.</span><span class="n">_identity_transfer</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1">#we transfer identities if the number of animals to be identified is less or equal to the one providing the knowledge</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">video</span><span class="o">.</span><span class="n">is_identity_transfer_possible</span><span class="p">():</span>
                    <span class="n">video</span><span class="o">.</span><span class="n">_identity_transfer</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Identity transfer is not possible. We will proceed by using standard knowledge transfer.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">same_animals</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span> <span class="ow">or</span> <span class="n">same_animals</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">video</span><span class="o">.</span><span class="n">_identity_transfer</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid input.&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">knowledge_transfer_flag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_tracking_with_knowledge_transfer</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid input, type either &#39;y&#39; or &#39;n&#39;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">video</span><span class="o">.</span><span class="n">copy_attributes_between_two_video_objects</span><span class="p">(</span><span class="n">old_video</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;knowledge_transfer_model_folder&#39;</span><span class="p">,</span>
                                                                    <span class="s1">&#39;identity_transfer&#39;</span><span class="p">,</span>
                                                                    <span class="s1">&#39;tracking_with_knowledge_transfer&#39;</span><span class="p">],</span>
                                                                    <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">old_video</span><span class="o">.</span><span class="n">tracking_with_knowledge_transfer</span><span class="p">:</span>
            <span class="n">video</span><span class="o">.</span><span class="n">knowledge_transfer_info_dict</span> <span class="o">=</span> <span class="n">old_video</span><span class="o">.</span><span class="n">knowledge_transfer_info_dict</span>
        <span class="n">video</span><span class="o">.</span><span class="n">use_previous_knowledge_transfer_decision</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1">#############################################################</span>
    <span class="c1">####################  Preprocessing   #######################</span>
    <span class="c1">#### 1. detect blobs in the video                        ####</span>
    <span class="c1">#### 2. create a list of potential global fragments      ####</span>
    <span class="c1">#### in which all animals are visible.                   ####</span>
    <span class="c1">#### 3. compute a model of the area of the animals,      ####</span>
    <span class="c1">#### train the Deep Crossing Detector and identify       ####</span>
    <span class="c1">#### the crossings                                       ####</span>
    <span class="c1">#### 4. compute global fragments                         ####</span>
    <span class="c1">#### 5. create a list of objects GlobalFragment()        ####</span>
    <span class="c1">#############################################################</span>
    <span class="c1">#Selection/loading preprocessing parameters</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Preprocessing ---------------------------------------------------------&#39;</span><span class="p">)</span>
    <span class="n">usePreviousPrecParams</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;preprocessing&#39;</span><span class="p">])</span>
    <span class="n">restore_segmentation</span> <span class="o">=</span> <span class="n">selectPreprocParams</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">old_video</span><span class="p">,</span> <span class="n">usePreviousPrecParams</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">preprocessing_parameters_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">video</span><span class="o">.</span><span class="vm">__dict__</span> <span class="k">if</span> <span class="s1">&#39;apply_ROI&#39;</span> <span class="ow">in</span> <span class="n">key</span>
                                    <span class="ow">or</span> <span class="s1">&#39;subtract_bkg&#39;</span> <span class="ow">in</span> <span class="n">key</span>
                                    <span class="ow">or</span> <span class="s1">&#39;min&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s1">&#39;max&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The parameters used to preprocess the video are </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">preprocessing_parameters_dict</span><span class="p">)</span>
    <span class="c1">#destroy windows to prevent openCV errors</span>
    <span class="c1">#Loading logo during preprocessing</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;./utils/loadingIdDeep.png&#39;</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Bars&#39;</span><span class="p">,</span><span class="n">img</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">preprocessing_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;preprocessing&#39;</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting preprocessing&quot;</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Bars&#39;</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">create_preprocessing_folder</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;restore segmentation &quot;</span><span class="p">,</span> <span class="n">restore_segmentation</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">old_video</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">old_video</span><span class="o">.</span><span class="n">has_been_segmented</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">restore_segmentation</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting segmentation&quot;</span><span class="p">)</span>
            <span class="n">blobs</span> <span class="o">=</span> <span class="n">segment</span><span class="p">(</span><span class="n">video</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Segmentation finished&quot;</span><span class="p">)</span>
            <span class="n">list_of_blobs</span> <span class="o">=</span> <span class="n">ListOfBlobs</span><span class="p">(</span><span class="n">blobs_in_video</span> <span class="o">=</span> <span class="n">blobs</span><span class="p">)</span>
            <span class="n">frames_with_more_blobs_than_animals</span> <span class="o">=</span> <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">check_maximal_number_of_blob</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames_with_more_blobs_than_animals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_preprocessing_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;min_threshold&#39;</span><span class="p">:</span> <span class="n">video</span><span class="o">.</span><span class="n">min_threshold</span><span class="p">,</span>
                                            <span class="s1">&#39;max_threshold&#39;</span><span class="p">:</span> <span class="n">video</span><span class="o">.</span><span class="n">max_threshold</span><span class="p">,</span>
                                            <span class="s1">&#39;min_area&#39;</span><span class="p">:</span> <span class="n">video</span><span class="o">.</span><span class="n">min_area</span><span class="p">,</span>
                                            <span class="s1">&#39;max_area&#39;</span><span class="p">:</span> <span class="n">video</span><span class="o">.</span><span class="n">max_area</span><span class="p">}</span>
                <span class="n">new_preprocessing_parameters</span> <span class="o">=</span> <span class="n">resegmentation_preview</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">frames_with_more_blobs_than_animals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_preprocessing_parameters</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">frame_number</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">frames_with_more_blobs_than_animals</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;Correcting segmentation&#39;</span><span class="p">):</span>
                    <span class="n">maximum_number_of_blobs</span> <span class="o">=</span> <span class="n">resegment</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">frame_number</span><span class="p">,</span> <span class="n">list_of_blobs</span><span class="p">,</span> <span class="n">new_preprocessing_parameters</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">maximum_number_of_blobs</span> <span class="o">&lt;=</span> <span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span><span class="p">:</span>
                        <span class="n">video</span><span class="o">.</span><span class="n">_resegmentation_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">frame_number</span><span class="p">,</span><span class="n">new_preprocessing_parameters</span><span class="p">))</span>
                <span class="n">frames_with_more_blobs_than_animals</span> <span class="o">=</span> <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">check_maximal_number_of_blob</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span><span class="p">)</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Bars&#39;</span><span class="p">)</span>

            <span class="n">video</span><span class="o">.</span><span class="n">_has_been_segmented</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_blobs</span><span class="o">.</span><span class="n">blobs_in_video</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">blobs_in_video</span> <span class="o">=</span> <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">blobs_in_video</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">number_of_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_blobs</span><span class="o">.</span><span class="n">blobs_in_video</span><span class="p">)</span>
                <span class="n">video</span><span class="o">.</span><span class="n">_number_of_frames</span> <span class="o">=</span> <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">number_of_frames</span>
                <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">blobs_path_segmented</span><span class="p">,</span> <span class="n">number_of_chunks</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Segmented blobs saved&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing maximum number of blobs detected in the video&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Load blobs and global fragments</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading previously segmented blobs&quot;</span><span class="p">)</span>
            <span class="n">preprocessing_parameters_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">video</span><span class="o">.</span><span class="vm">__dict__</span>
                                            <span class="k">if</span> <span class="s1">&#39;apply_ROI&#39;</span> <span class="ow">in</span> <span class="n">key</span>
                                            <span class="ow">or</span> <span class="s1">&#39;subtract_bkg&#39;</span> <span class="ow">in</span> <span class="n">key</span>
                                            <span class="ow">or</span> <span class="s1">&#39;min_&#39;</span> <span class="ow">in</span> <span class="n">key</span>
                                            <span class="ow">or</span> <span class="s1">&#39;max_&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;The parameters used to preprocess the video are </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">preprocessing_parameters_dict</span><span class="p">)</span>
            <span class="n">list_of_blobs</span> <span class="o">=</span> <span class="n">ListOfBlobs</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">old_video</span><span class="o">.</span><span class="n">blobs_path_segmented</span><span class="p">)</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_has_been_segmented</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Segmented blobs loaded&quot;</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_erosion_kernel_size</span> <span class="o">=</span> <span class="n">compute_erosion_disk</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">blobs_in_video</span><span class="p">)</span>
            <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">erode</span><span class="p">(</span><span class="n">video</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing a model of the area of the individuals&quot;</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_model_area</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">_median_body_length</span> <span class="o">=</span> <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">compute_model_area_and_body_length</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">compute_identification_image_size</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">median_body_length</span><span class="p">)</span>
        <span class="c1"># video._identification_image_size = (48, 48, 1)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">blobs_are_connected</span><span class="p">:</span>
            <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">compute_overlapping_between_subsequent_frames</span><span class="p">()</span>
        <span class="n">detect_crossings</span><span class="p">(</span><span class="n">list_of_blobs</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">model_area</span><span class="p">,</span> <span class="n">use_network</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">compute_overlapping_between_subsequent_frames</span><span class="p">()</span>
        <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">compute_fragment_identifier_and_blob_index</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span><span class="p">)</span>
        <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">compute_crossing_fragment_identifier</span><span class="p">()</span>
        <span class="n">fragments</span> <span class="o">=</span> <span class="n">create_list_of_fragments</span><span class="p">(</span><span class="n">list_of_blobs</span><span class="o">.</span><span class="n">blobs_in_video</span><span class="p">,</span>
                                            <span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span><span class="p">)</span>
        <span class="n">list_of_fragments</span> <span class="o">=</span> <span class="n">ListOfFragments</span><span class="p">(</span><span class="n">fragments</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_fragment_identifier_to_index</span> <span class="o">=</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">get_fragment_identifier_to_index_list</span><span class="p">()</span>
        <span class="c1">#compute the global fragments (all animals are visible + each animals overlaps</span>
        <span class="c1">#with a single blob in the consecutive frame + the blobs respect the area model)</span>
        <span class="n">global_fragments</span> <span class="o">=</span> <span class="n">create_list_of_global_fragments</span><span class="p">(</span><span class="n">list_of_blobs</span><span class="o">.</span><span class="n">blobs_in_video</span><span class="p">,</span>
                                                            <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span><span class="p">,</span>
                                                            <span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span><span class="p">)</span>
        <span class="n">list_of_global_fragments</span> <span class="o">=</span> <span class="n">ListOfGlobalFragments</span><span class="p">(</span><span class="n">global_fragments</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">number_of_global_fragments</span> <span class="o">=</span> <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">number_of_global_fragments</span>
        <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">filter_candidates_global_fragments_for_accumulation</span><span class="p">()</span>
        <span class="n">video</span><span class="o">.</span><span class="n">number_of_global_fragments_candidates_for_accumulation</span> <span class="o">=</span> <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">number_of_global_fragments</span>
        <span class="n">video</span><span class="o">.</span><span class="n">individual_fragments_lenghts</span><span class="p">,</span> \
        <span class="n">video</span><span class="o">.</span><span class="n">individual_fragments_distance_travelled</span><span class="p">,</span> \
            <span class="n">video</span><span class="o">.</span><span class="n">_gamma_fit_parameters</span> <span class="o">=</span> <span class="n">compute_and_plot_fragments_statistics</span><span class="p">(</span><span class="n">video</span><span class="p">,</span>
                                                                            <span class="n">video</span><span class="o">.</span><span class="n">model_area</span><span class="p">,</span>
                                                                            <span class="n">list_of_blobs</span><span class="p">,</span>
                                                                            <span class="n">list_of_fragments</span><span class="p">,</span>
                                                                            <span class="n">list_of_global_fragments</span><span class="p">)</span>
        <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">relink_fragments_to_global_fragments</span><span class="p">(</span><span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_number_of_unique_images_in_global_fragments</span> <span class="o">=</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">compute_total_number_of_images_in_global_fragments</span><span class="p">()</span>
        <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">compute_maximum_number_of_images</span><span class="p">()</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_maximum_number_of_images_in_global_fragments</span> <span class="o">=</span> <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">maximum_number_of_images</span>
        <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">get_accumulable_individual_fragments_identifiers</span><span class="p">(</span><span class="n">list_of_global_fragments</span><span class="p">)</span>
        <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">get_not_accumulable_individual_fragments_identifiers</span><span class="p">(</span><span class="n">list_of_global_fragments</span><span class="p">)</span>
        <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">set_fragments_as_accumulable_or_not_accumulable</span><span class="p">()</span>
        <span class="c1">#save connected blobs in video (organized frame-wise)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_has_been_preprocessed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">blobs_path</span><span class="p">,</span> <span class="n">number_of_chunks</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">)</span>
        <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">fragments_path</span><span class="p">)</span>
        <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">global_fragments_path</span><span class="p">,</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Blobs detection and fragmentation finished succesfully.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Bars&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading preprocessed video&quot;</span><span class="p">)</span>
        <span class="n">path_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;preprocessing_folder&#39;</span><span class="p">,</span> <span class="s1">&#39;blobs_path&#39;</span><span class="p">,</span> <span class="s1">&#39;global_fragments_path&#39;</span><span class="p">,</span> <span class="s1">&#39;fragments_path&#39;</span><span class="p">,</span> <span class="s1">&#39;gamma_fit_parameters&#39;</span><span class="p">]</span>
        <span class="n">video</span><span class="o">.</span><span class="n">copy_attributes_between_two_video_objects</span><span class="p">(</span><span class="n">old_video</span><span class="p">,</span> <span class="n">path_attributes</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_has_been_segmented</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_has_been_preprocessed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># Load blobs and global fragments</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading blob objects&quot;</span><span class="p">)</span>
        <span class="n">list_of_blobs</span> <span class="o">=</span> <span class="n">ListOfBlobs</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">blobs_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading list of fragments&quot;</span><span class="p">)</span>
        <span class="n">list_of_fragments</span> <span class="o">=</span> <span class="n">ListOfFragments</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">fragments_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading list of global fragments&quot;</span><span class="p">)</span>
        <span class="n">list_of_global_fragments</span> <span class="o">=</span> <span class="n">ListOfGlobalFragments</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">global_fragments_path</span><span class="p">,</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">preprocessing_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">video</span><span class="o">.</span><span class="n">preprocessing_time</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#############################################################</span>
    <span class="c1">##################   Protocols cascade   ####################</span>
    <span class="c1">#############################################################</span>
    <span class="c1">#### Accumulation ####</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Accumulation 0 ---------------------------------------------------------&#39;</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">first_accumulation_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">video</span><span class="o">.</span><span class="n">accumulation_trial</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">video</span><span class="o">.</span><span class="n">create_accumulation_folder</span><span class="p">(</span><span class="n">iteration_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delete</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;first_accumulation&#39;</span><span class="p">]))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set accumulation network parameters&quot;</span><span class="p">)</span>
    <span class="n">number_of_animals</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">video</span><span class="o">.</span><span class="n">identity_transfer</span> <span class="k">else</span> <span class="n">video</span><span class="o">.</span><span class="n">knowledge_transfer_info_dict</span><span class="p">[</span><span class="s1">&#39;number_of_animals&#39;</span><span class="p">]</span>
    <span class="n">accumulation_network_params</span> <span class="o">=</span> <span class="n">NetworkParams</span><span class="p">(</span><span class="n">number_of_animals</span><span class="p">,</span>
                                <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span>
                                <span class="n">keep_prob</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                                <span class="n">scopes_layers_to_optimize</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">save_folder</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">accumulation_folder</span><span class="p">,</span>
                                <span class="n">image_size</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">identification_image_size</span><span class="p">,</span>
                                <span class="n">video_path</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">video_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;first_accumulation&#39;</span><span class="p">]):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting accumulation&quot;</span><span class="p">)</span>
        <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">roll_back_to</span> <span class="o">=</span> <span class="s1">&#39;fragmentation&#39;</span><span class="p">)</span>
        <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">roll_back_to</span> <span class="o">=</span> <span class="s1">&#39;fragmentation&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">video</span><span class="o">.</span><span class="n">tracking_with_knowledge_transfer</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">video</span><span class="o">.</span><span class="n">identity_transfer</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;We will restore the network from a previous model (convolutional layers and classifier): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">video</span><span class="o">.</span><span class="n">knowledge_transfer_model_folder</span><span class="p">)</span>
                <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">restore_folder</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">knowledge_transfer_model_folder</span>
                <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">check_identity_transfer_consistency</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">knowledge_transfer_info_dict</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;We will restore the network from a previous model (only convolutional layers): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">video</span><span class="o">.</span><span class="n">knowledge_transfer_model_folder</span><span class="p">)</span>
                <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">knowledge_transfer_folder</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">knowledge_transfer_model_folder</span>
            <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">scopes_layers_to_optimize</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fully-connected1&#39;</span><span class="p">,</span><span class="s1">&#39;fully_connected_pre_softmax&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The network will be trained from scratch during accumulation&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialising accumulation network&quot;</span><span class="p">)</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">ConvNetwork</span><span class="p">(</span><span class="n">accumulation_network_params</span><span class="p">)</span>
        <span class="c1">#if knowledge transfer is performed on the same animals we don&#39;t reinitialise the classification part of the net</span>
        <span class="k">if</span> <span class="n">video</span><span class="o">.</span><span class="n">tracking_with_knowledge_transfer</span><span class="p">:</span>
            <span class="n">net</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialising accumulation manager&quot;</span><span class="p">)</span>
        <span class="c1"># the list of global fragments is ordered in place from the distance (in frames) wrt</span>
        <span class="c1"># the core of the first global fragment that will be accumulated</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_first_frame_first_global_fragment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">set_first_global_fragment_for_accumulation</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">accumulation_trial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">video</span><span class="o">.</span><span class="n">identity_transfer</span> <span class="ow">and</span> <span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span> <span class="o">&lt;</span> <span class="n">video</span><span class="o">.</span><span class="n">knowledge_transfer_info_dict</span><span class="p">[</span><span class="s1">&#39;number_of_animals&#39;</span><span class="p">]:</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>
            <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">number_of_animals</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span>
            <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">_restore_folder</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">knowledge_transfer_folder</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">knowledge_transfer_model_folder</span>
            <span class="n">net</span> <span class="o">=</span> <span class="n">ConvNetwork</span><span class="p">(</span><span class="n">accumulation_network_params</span><span class="p">)</span>
            <span class="n">net</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

        <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">order_by_distance_to_the_first_global_fragment_for_accumulation</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">accumulation_trial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">accumulation_manager</span> <span class="o">=</span> <span class="n">AccumulationManager</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">list_of_fragments</span><span class="p">,</span>
                                                    <span class="n">list_of_global_fragments</span><span class="p">,</span>
                                                    <span class="n">threshold_acceptable_accumulation</span> <span class="o">=</span> <span class="n">THRESHOLD_ACCEPTABLE_ACCUMULATION</span><span class="p">)</span>
        <span class="c1">#set global epoch counter to 0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start accumulation&quot;</span><span class="p">)</span>
        <span class="n">global_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_ratio_accumulated_images</span> <span class="o">=</span> <span class="n">accumulate</span><span class="p">(</span><span class="n">accumulation_manager</span><span class="p">,</span>
                                            <span class="n">video</span><span class="p">,</span>
                                            <span class="n">global_step</span><span class="p">,</span>
                                            <span class="n">net</span><span class="p">,</span>
                                            <span class="n">video</span><span class="o">.</span><span class="n">identity_transfer</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Accumulation finished. There are no more acceptable global_fragments for training&quot;</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_first_accumulation_finished</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_percentage_of_accumulated_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">video</span><span class="o">.</span><span class="n">ratio_accumulated_images</span><span class="p">]</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving fragments&quot;</span><span class="p">)</span>
        <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">fragments_path</span><span class="p">)</span>
        <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">global_fragments_path</span><span class="p">,</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restoring accumulation network&quot;</span><span class="p">)</span>
        <span class="n">list_of_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accumulation_folder&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;second_accumulation_finished&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;number_of_accumulated_global_fragments&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;number_of_non_certain_global_fragments&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;number_of_randomly_assigned_global_fragments&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;number_of_nonconsistent_global_fragments&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;number_of_nonunique_global_fragments&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;number_of_acceptable_global_fragments&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;validation_accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;validation_individual_accuracies&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;training_accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;training_individual_accuracies&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;percentage_of_accumulated_images&#39;</span><span class="p">,</span> <span class="s1">&#39;accumulation_trial&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ratio_accumulated_images&#39;</span><span class="p">,</span> <span class="s1">&#39;first_accumulation_finished&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;identity_transfer&#39;</span><span class="p">,</span> <span class="s1">&#39;accumulation_statistics&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;first_frame_first_global_fragment&#39;</span><span class="p">]</span>
        <span class="n">is_property</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
        <span class="n">video</span><span class="o">.</span><span class="n">copy_attributes_between_two_video_objects</span><span class="p">(</span><span class="n">old_video</span><span class="p">,</span> <span class="n">list_of_attributes</span><span class="p">,</span> <span class="n">is_property</span> <span class="o">=</span> <span class="n">is_property</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_ratio_accumulated_images</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">percentage_of_accumulated_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">restore_folder</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">_accumulation_folder</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">ConvNetwork</span><span class="p">(</span><span class="n">accumulation_network_params</span><span class="p">)</span>
        <span class="n">net</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving video&quot;</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">video</span><span class="o">.</span><span class="n">first_accumulation_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">video</span><span class="o">.</span><span class="n">first_accumulation_time</span>
    <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">save_light_list</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">_accumulation_folder</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">video</span><span class="o">.</span><span class="n">ratio_accumulated_images</span> <span class="o">&gt;</span> <span class="n">THRESHOLD_ACCEPTABLE_ACCUMULATION</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">first_frame_first_global_fragment</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_first_frame_first_global_fragment</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">first_frame_first_global_fragment</span><span class="p">[</span><span class="n">video</span><span class="o">.</span><span class="n">accumulation_trial</span><span class="p">]</span>
        <span class="n">video</span><span class="o">.</span><span class="n">assignment_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;assignment&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Assignment 1 ---------------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">roll_back_to</span> <span class="o">=</span> <span class="s1">&#39;accumulation&#39;</span><span class="p">)</span>
            <span class="n">assigner</span><span class="p">(</span><span class="n">list_of_fragments</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">net</span><span class="p">)</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_has_been_assigned</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1">### NOTE: save all the assigner statistics</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">### NOTE: load all the assigner statistics</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_has_been_assigned</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">video</span><span class="o">.</span><span class="n">assignment_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">video</span><span class="o">.</span><span class="n">assignment_time</span>
        <span class="n">video</span><span class="o">.</span><span class="n">pretraining_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">video</span><span class="o">.</span><span class="n">second_accumulation_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Pretraining ---------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">pretraining_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">video</span><span class="o">.</span><span class="n">create_pretraining_folder</span><span class="p">()</span>
        <span class="n">pretrain_network_params</span> <span class="o">=</span> <span class="n">NetworkParams</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span><span class="p">,</span>
                                                <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                                <span class="n">keep_prob</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                                                <span class="n">use_adam_optimiser</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                <span class="n">scopes_layers_to_optimize</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                                <span class="n">save_folder</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">pretraining_folder</span><span class="p">,</span>
                                                <span class="n">image_size</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">identification_image_size</span><span class="p">,</span>
                                                <span class="n">video_path</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">video_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;pretraining&#39;</span><span class="p">]:</span>
            <span class="c1">#### Pre-trainer ####</span>
            <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">roll_back_to</span> <span class="o">=</span> <span class="s1">&#39;fragmentation&#39;</span><span class="p">)</span>
            <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">order_by_distance_travelled</span><span class="p">()</span>
            <span class="n">pre_trainer</span><span class="p">(</span><span class="n">old_video</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">list_of_fragments</span><span class="p">,</span> <span class="n">list_of_global_fragments</span><span class="p">,</span> <span class="n">pretrain_network_params</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pretraining ended&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving changes in video object&quot;</span><span class="p">)</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_has_been_pretrained</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1">### NOTE: save pre-training statistics</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restoring pretrained network&quot;</span><span class="p">)</span>
            <span class="n">video</span><span class="o">.</span><span class="n">copy_attributes_between_two_video_objects</span><span class="p">(</span><span class="n">old_video</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;pretraining_folder&#39;</span><span class="p">,</span> <span class="s1">&#39;has_been_pretrained&#39;</span><span class="p">])</span>
            <span class="n">pretrain_network_params</span><span class="o">.</span><span class="n">restore_folder</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">pretraining_folder</span>
            <span class="n">net</span> <span class="o">=</span> <span class="n">ConvNetwork</span><span class="p">(</span><span class="n">pretrain_network_params</span><span class="p">)</span>
            <span class="n">net</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
            <span class="c1"># Set preprocessed flag to True</span>
            <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1">### NOTE: load pre-training statistics</span>
        <span class="n">video</span><span class="o">.</span><span class="n">pretraining_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">video</span><span class="o">.</span><span class="n">pretraining_time</span>
        <span class="c1">#### Accumulation ####</span>
        <span class="n">video</span><span class="o">.</span><span class="n">second_accumulation_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_percentage_of_accumulated_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">video</span><span class="o">.</span><span class="n">ratio_accumulated_images</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;****************************************************************&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;**************************** loadPreviousDict &quot;</span><span class="p">,</span> <span class="n">loadPreviousDict</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;****************************************************************&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;second_accumulation&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">first_frame_first_global_fragment</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">video</span><span class="o">.</span><span class="n">_first_frame_first_global_fragment</span> <span class="o">=</span> <span class="p">[</span><span class="n">video</span><span class="o">.</span><span class="n">first_frame_first_global_fragment</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Accumulation </span><span class="si">%i</span><span class="s1"> ---------------------------------------------------------&#39;</span> <span class="o">%</span><span class="n">i</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting accumulation&quot;</span><span class="p">)</span>
                <span class="n">video</span><span class="o">.</span><span class="n">create_accumulation_folder</span><span class="p">(</span><span class="n">iteration_number</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">delete</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;second_accumulation&#39;</span><span class="p">]))</span>
                <span class="n">video</span><span class="o">.</span><span class="n">accumulation_trial</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">roll_back_to</span> <span class="o">=</span> <span class="s1">&#39;fragmentation&#39;</span><span class="p">)</span>
                <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">roll_back_to</span> <span class="o">=</span> <span class="s1">&#39;fragmentation&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;We will restore the network from a previous pretraining: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">video</span><span class="o">.</span><span class="n">pretraining_folder</span><span class="p">)</span>
                <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">save_folder</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">accumulation_folder</span>
                <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">restore_folder</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">pretraining_folder</span>
                <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">scopes_layers_to_optimize</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fully-connected1&#39;</span><span class="p">,</span><span class="s1">&#39;fully_connected_pre_softmax&#39;</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialising accumulation network&quot;</span><span class="p">)</span>
                <span class="n">net</span> <span class="o">=</span> <span class="n">ConvNetwork</span><span class="p">(</span><span class="n">accumulation_network_params</span><span class="p">)</span>
                <span class="n">net</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
                <span class="n">net</span><span class="o">.</span><span class="n">reinitialize_softmax_and_fully_connected</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialising accumulation manager&quot;</span><span class="p">)</span>
                <span class="n">video</span><span class="o">.</span><span class="n">_first_frame_first_global_fragment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">set_first_global_fragment_for_accumulation</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">accumulation_trial</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">video</span><span class="o">.</span><span class="n">identity_transfer</span> <span class="ow">and</span> <span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span> <span class="o">&lt;</span> <span class="n">video</span><span class="o">.</span><span class="n">knowledge_transfer_info_dict</span><span class="p">[</span><span class="s1">&#39;number_of_animals&#39;</span><span class="p">]:</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>
                    <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">number_of_animals</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span>
                    <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">restore_folder</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">pretraining_folder</span>
                    <span class="n">net</span> <span class="o">=</span> <span class="n">ConvNetwork</span><span class="p">(</span><span class="n">accumulation_network_params</span><span class="p">)</span>
                    <span class="n">net</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
                    <span class="n">net</span><span class="o">.</span><span class="n">reinitialize_softmax_and_fully_connected</span><span class="p">()</span>
                <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">order_by_distance_to_the_first_global_fragment_for_accumulation</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">accumulation_trial</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">accumulation_manager</span> <span class="o">=</span> <span class="n">AccumulationManager</span><span class="p">(</span><span class="n">video</span><span class="p">,</span>
                                                            <span class="n">list_of_fragments</span><span class="p">,</span> <span class="n">list_of_global_fragments</span><span class="p">,</span>
                                                            <span class="n">threshold_acceptable_accumulation</span> <span class="o">=</span> <span class="n">THRESHOLD_ACCEPTABLE_ACCUMULATION</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start accumulation&quot;</span><span class="p">)</span>
                <span class="n">global_step</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">video</span><span class="o">.</span><span class="n">_ratio_accumulated_images</span> <span class="o">=</span> <span class="n">accumulate</span><span class="p">(</span><span class="n">accumulation_manager</span><span class="p">,</span>
                                                            <span class="n">video</span><span class="p">,</span>
                                                            <span class="n">global_step</span><span class="p">,</span>
                                                            <span class="n">net</span><span class="p">,</span>
                                                            <span class="n">video</span><span class="o">.</span><span class="n">identity_transfer</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Accumulation finished. There are no more acceptable global_fragments for training&quot;</span><span class="p">)</span>
                <span class="n">video</span><span class="o">.</span><span class="n">_percentage_of_accumulated_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">ratio_accumulated_images</span><span class="p">)</span>
                <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">save_light_list</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">_accumulation_folder</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">video</span><span class="o">.</span><span class="n">ratio_accumulated_images</span> <span class="o">&gt;</span> <span class="n">THRESHOLD_ACCEPTABLE_ACCUMULATION</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This accumulation was not satisfactory. Try to start from a different global fragment&quot;</span><span class="p">)</span>



            <span class="n">video</span><span class="o">.</span><span class="n">accumulation_trial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">percentage_of_accumulated_images</span><span class="p">)</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_first_frame_first_global_fragment</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">first_frame_first_global_fragment</span><span class="p">[</span><span class="n">video</span><span class="o">.</span><span class="n">accumulation_trial</span><span class="p">]</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_ratio_accumulated_images</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">percentage_of_accumulated_images</span><span class="p">[</span><span class="n">video</span><span class="o">.</span><span class="n">accumulation_trial</span><span class="p">]</span>
            <span class="n">accumulation_folder_name</span> <span class="o">=</span> <span class="s1">&#39;accumulation_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">accumulation_trial</span><span class="p">)</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_accumulation_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">session_folder</span><span class="p">,</span> <span class="n">accumulation_folder_name</span><span class="p">)</span>
            <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">load_light_list</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">_accumulation_folder</span><span class="p">)</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_second_accumulation_finished</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving global fragments&quot;</span><span class="p">)</span>
            <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">fragments_path</span><span class="p">)</span>
            <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">global_fragments_path</span><span class="p">,</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span>
            <span class="c1">### NOTE: save second_accumulation statistics</span>
            <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">list_of_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accumulation_folder&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;second_accumulation_finished&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;number_of_accumulated_global_fragments&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;number_of_non_certain_global_fragments&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;number_of_randomly_assigned_global_fragments&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;number_of_nonconsistent_global_fragments&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;number_of_nonunique_global_fragments&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;number_of_acceptable_global_fragments&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;validation_accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;validation_individual_accuracies&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;training_accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;training_individual_accuracies&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;percentage_of_accumulated_images&#39;</span><span class="p">,</span> <span class="s1">&#39;accumulation_trial&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;ratio_accumulated_images&#39;</span><span class="p">,</span> <span class="s1">&#39;first_accumulation_finished&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;identity_transfer&#39;</span><span class="p">,</span> <span class="s1">&#39;accumulation_statistics&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;first_frame_first_global_fragment&#39;</span><span class="p">]</span>
            <span class="n">is_property</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
            <span class="n">video</span><span class="o">.</span><span class="n">copy_attributes_between_two_video_objects</span><span class="p">(</span><span class="n">old_video</span><span class="p">,</span> <span class="n">list_of_attributes</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restoring trained network&quot;</span><span class="p">)</span>
            <span class="n">accumulation_network_params</span><span class="o">.</span><span class="n">restore_folder</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">_accumulation_folder</span>
            <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">load_light_list</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">_accumulation_folder</span><span class="p">)</span>
            <span class="n">net</span> <span class="o">=</span> <span class="n">ConvNetwork</span><span class="p">(</span><span class="n">accumulation_network_params</span><span class="p">)</span>
            <span class="n">net</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
            <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1">### NOTE: load pre-training statistics</span>
        <span class="n">video</span><span class="o">.</span><span class="n">second_accumulation_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">video</span><span class="o">.</span><span class="n">second_accumulation_time</span>
        <span class="n">video</span><span class="o">.</span><span class="n">assignment_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;assignment&#39;</span><span class="p">]:</span>
            <span class="c1">#### Assigner ####</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">---------------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">roll_back_to</span> <span class="o">=</span> <span class="s1">&#39;accumulation&#39;</span><span class="p">)</span>
            <span class="n">assigner</span><span class="p">(</span><span class="n">list_of_fragments</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">net</span><span class="p">)</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_has_been_assigned</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1">### NOTE: save all the assigner statistics</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">### NOTE: load all the assigner statistics</span>
            <span class="n">video</span><span class="o">.</span><span class="n">_has_been_assigned</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">video</span><span class="o">.</span><span class="n">assignment_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">video</span><span class="o">.</span><span class="n">assignment_time</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Saving list of fragments, list of global fragments and video object&quot;</span><span class="p">)</span>
    <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">fragments_path</span><span class="p">)</span>
    <span class="n">list_of_global_fragments</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">global_fragments_path</span><span class="p">,</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1">#############################################################</span>
    <span class="c1">################### CNN-visualisation  ######################</span>
    <span class="c1">####</span>
    <span class="c1">#############################################################</span>
    <span class="c1"># accumulated_global_fragments = [global_fragment for global_fragment in global_fragments</span>
    <span class="c1">#                                 if global_fragment.used_for_training]</span>
    <span class="c1"># for i in range(10):</span>
    <span class="c1">#     image = accumulated_global_fragments[0].portraits[0][i]</span>
    <span class="c1">#     image = np.expand_dims(image, 2)</span>
    <span class="c1">#     image = np.expand_dims(image, 0)</span>
    <span class="c1">#     label = accumulated_global_fragments[0]._temporary_ids[0]</span>
    <span class="c1">#</span>
    <span class="c1">#     visualise(video, net, image, label)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;************** Before solving duplications ************************&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of fragments with zero identity: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span>
                                                            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">assigned_identity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of fragments with zero identity by P2: &quot;</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">assigned_identity</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;zero_identity_assigned_by_P2&#39;</span><span class="p">)]))</span>

    <span class="c1">#############################################################</span>
    <span class="c1">###################   Solve duplications      ###############</span>
    <span class="c1">####</span>
    <span class="c1">#############################################################</span>
    <span class="n">video</span><span class="o">.</span><span class="n">solve_duplications_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;solving_duplications&#39;</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start checking for and solving duplications&quot;</span><span class="p">)</span>
        <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">roll_back_to</span> <span class="o">=</span> <span class="s1">&#39;assignment&#39;</span><span class="p">)</span>
        <span class="n">mark_fragments_as_duplications</span><span class="p">(</span><span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span>
        <span class="n">solve_duplications</span><span class="p">(</span><span class="n">list_of_fragments</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">first_frame_first_global_fragment</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_has_duplications_solved</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving&quot;</span><span class="p">)</span>
        <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">fragments_path</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Duplications have already been checked. Using previous information&quot;</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_has_duplications_solved</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">video</span><span class="o">.</span><span class="n">solve_duplications_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">video</span><span class="o">.</span><span class="n">solve_duplications_time</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;************** After solving duplications ************************&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of fragments with zero identity: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span>
                                                            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">assigned_identity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of fragments with zero identity by P2: &quot;</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">assigned_identity</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;zero_identity_assigned_by_P2&#39;</span><span class="p">)]))</span>

    <span class="c1">#############################################################</span>
    <span class="c1">###################  Solving impossible jumps    ############</span>
    <span class="c1">#############################################################</span>
    <span class="n">video</span><span class="o">.</span><span class="n">solve_impossible_jumps_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">**** Correct impossible velocity jump ****&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Solving impossible velocity jumps&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">old_video</span><span class="p">,</span><span class="s1">&#39;velocity_threshold&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">video</span><span class="p">,</span><span class="s1">&#39;velocity_threshold&#39;</span><span class="p">):</span>
        <span class="n">video</span><span class="o">.</span><span class="n">velocity_threshold</span> <span class="o">=</span> <span class="n">old_video</span><span class="o">.</span><span class="n">velocity_threshold</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">old_video</span><span class="p">,</span> <span class="s1">&#39;velocity_threshold&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">video</span><span class="p">,</span><span class="s1">&#39;velocity_threshold&#39;</span><span class="p">):</span>
        <span class="n">video</span><span class="o">.</span><span class="n">velocity_threshold</span> <span class="o">=</span> <span class="n">compute_model_velocity</span><span class="p">(</span><span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">number_of_animals</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="n">VEL_PERCENTILE</span><span class="p">)</span>
    <span class="n">correct_impossible_velocity_jumps</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">list_of_fragments</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving&quot;</span><span class="p">)</span>
    <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">fragments_path</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">solve_impossible_jumps_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">video</span><span class="o">.</span><span class="n">solve_impossible_jumps_time</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;************** After solving impossible jumps ************************&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of fragments with zero identity: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span>
                                                            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">assigned_identity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of fragments with zero _was_a_crossingidentity by P2: &quot;</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">assigned_identity</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;zero_identity_assigned_by_P2&#39;</span><span class="p">)]))</span>

    <span class="c1">#############################################################</span>
    <span class="c1">############# Check identification consistency ##############</span>
    <span class="c1">####</span>
    <span class="c1">#############################################################</span>



    <span class="c1">#############################################################</span>
    <span class="c1">##############   Invididual fragments stats #################</span>
    <span class="c1">####</span>
    <span class="c1">#############################################################</span>
    <span class="n">video</span><span class="o">.</span><span class="n">individual_fragments_stats</span> <span class="o">=</span> <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">list_of_global_fragments</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">compute_overall_P2</span><span class="p">(</span><span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;overall_P2 &quot;</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">overall_P2</span><span class="p">)</span>
    <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">plot_stats</span><span class="p">(</span><span class="n">video</span><span class="p">)</span>
    <span class="n">list_of_fragments</span><span class="o">.</span><span class="n">save_light_list</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">_accumulation_folder</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1">#############################################################</span>
    <span class="c1">##############   Update list of blobs   #####################</span>
    <span class="c1">####</span>
    <span class="c1">#############################################################</span>
    <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">update_from_list_of_fragments</span><span class="p">(</span><span class="n">list_of_fragments</span><span class="o">.</span><span class="n">fragments</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">fragment_identifier_to_index</span><span class="p">)</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">compute_nose_and_head_coordinates</span><span class="p">()</span>
    <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">blobs_path</span><span class="p">,</span> <span class="n">number_of_chunks</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">)</span>

    <span class="c1">#############################################################</span>
    <span class="c1">############ Create trajectories (w gaps) ###################</span>
    <span class="c1">#############################################################</span>
    <span class="n">video</span><span class="o">.</span><span class="n">generate_trajectories_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;trajectories&#39;</span><span class="p">]:</span>
        <span class="n">video</span><span class="o">.</span><span class="n">create_trajectories_folder</span><span class="p">()</span>
        <span class="n">trajectories_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">trajectories_folder</span><span class="p">,</span> <span class="s1">&#39;trajectories.npy&#39;</span><span class="p">)</span>
        <span class="n">trajectories</span> <span class="o">=</span> <span class="n">produce_output_dict</span><span class="p">(</span><span class="n">list_of_blobs</span><span class="o">.</span><span class="n">blobs_in_video</span><span class="p">,</span> <span class="n">video</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">trajectories_file</span><span class="p">,</span> <span class="n">trajectories</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving trajectories&quot;</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_has_trajectories</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_has_trajectories</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">video</span><span class="o">.</span><span class="n">generate_trajectories_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">video</span><span class="o">.</span><span class="n">generate_trajectories_time</span>

    <span class="c1">#############################################################</span>
    <span class="c1">##############   Compute groundtruth    #####################</span>
    <span class="c1">#############################################################</span>
    <span class="n">groundtruth_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">video_folder</span><span class="p">,</span><span class="s1">&#39;_groundtruth.npy&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">groundtruth_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">**** Computing accuracy wrt. groundtruth ****&quot;</span><span class="p">)</span>
        <span class="n">groundtruth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">groundtruth_path</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">blobs_in_video_groundtruth</span> <span class="o">=</span> <span class="n">groundtruth</span><span class="o">.</span><span class="n">blobs_in_video</span><span class="p">[</span><span class="n">groundtruth</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">groundtruth</span><span class="o">.</span><span class="n">end</span><span class="p">]</span>
        <span class="n">blobs_in_video</span> <span class="o">=</span> <span class="n">list_of_blobs</span><span class="o">.</span><span class="n">blobs_in_video</span><span class="p">[</span><span class="n">groundtruth</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">groundtruth</span><span class="o">.</span><span class="n">end</span><span class="p">]</span>
        <span class="n">video</span><span class="o">.</span><span class="n">gt_accuracy</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">gt_results</span> <span class="o">=</span> <span class="n">get_accuracy_wrt_groundtruth</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">blobs_in_video_groundtruth</span><span class="p">,</span> <span class="n">blobs_in_video</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">gt_start_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">groundtruth</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">groundtruth</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">video</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">video</span><span class="o">.</span><span class="n">generate_trajectories_time</span><span class="p">,</span>
                            <span class="n">video</span><span class="o">.</span><span class="n">solve_impossible_jumps_time</span><span class="p">,</span>
                            <span class="n">video</span><span class="o">.</span><span class="n">solve_duplications_time</span><span class="p">,</span>
                            <span class="n">video</span><span class="o">.</span><span class="n">assignment_time</span><span class="p">,</span>
                            <span class="n">video</span><span class="o">.</span><span class="n">second_accumulation_time</span><span class="p">,</span>
                            <span class="n">video</span><span class="o">.</span><span class="n">pretraining_time</span><span class="p">,</span>
                            <span class="n">video</span><span class="o">.</span><span class="n">assignment_time</span><span class="p">,</span>
                            <span class="n">video</span><span class="o">.</span><span class="n">first_accumulation_time</span><span class="p">,</span>
                            <span class="n">video</span><span class="o">.</span><span class="n">preprocessing_time</span><span class="p">])</span>
    <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1">#############################################################</span>
    <span class="c1">##############   Solve crossigns   ##########################</span>
    <span class="c1">####</span>
    <span class="c1">#############################################################</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">**** Assign crossings ****&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;crossings&#39;</span><span class="p">]:</span>
        <span class="n">list_of_blobs_no_gaps</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">list_of_blobs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">list_of_blobs_no_gaps</span><span class="o">.</span><span class="n">blobs_in_video</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;_was_a_crossing&#39;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;adding attribute was_a_crossing to every blob&quot;</span><span class="p">)</span>
            <span class="p">[</span><span class="nb">setattr</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="s1">&#39;_was_a_crossing&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">blobs_in_frame</span> <span class="ow">in</span>
                <span class="n">list_of_blobs_no_gaps</span><span class="o">.</span><span class="n">blobs_in_video</span> <span class="k">for</span> <span class="n">blob</span> <span class="ow">in</span> <span class="n">blobs_in_frame</span><span class="p">]</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_has_crossings_solved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">list_of_blobs_no_gaps</span> <span class="o">=</span> <span class="n">close_trajectories_gaps</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">list_of_blobs_no_gaps</span><span class="p">,</span> <span class="n">list_of_fragments</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">blobs_no_gaps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">blobs_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;blobs_collection_no_gaps.npy&#39;</span><span class="p">)</span>
        <span class="n">list_of_blobs_no_gaps</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">path_to_save</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">blobs_no_gaps_path</span><span class="p">,</span> <span class="n">number_of_chunks</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_has_crossings_solved</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">video</span><span class="o">.</span><span class="n">copy_attributes_between_two_video_objects</span><span class="p">(</span><span class="n">old_video</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;blobs_no_gaps_path&#39;</span><span class="p">],</span> <span class="p">[</span><span class="kc">False</span><span class="p">])</span>
        <span class="n">list_of_blobs_no_gaps</span> <span class="o">=</span> <span class="n">ListOfBlobs</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">blobs_no_gaps_path</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_has_crossings_solved</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1">#############################################################</span>
    <span class="c1">########### Create trajectories (w/o gaps) ##################</span>
    <span class="c1">#############################################################</span>
    <span class="n">video</span><span class="o">.</span><span class="n">generate_trajectories_wogaps_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">loadPreviousDict</span><span class="p">[</span><span class="s1">&#39;trajectories_wo_gaps&#39;</span><span class="p">]:</span>
        <span class="n">video</span><span class="o">.</span><span class="n">create_trajectories_wo_gaps_folder</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating trajectories. The trajectories files are stored in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">video</span><span class="o">.</span><span class="n">trajectories_wo_gaps_folder</span><span class="p">)</span>
        <span class="n">trajectories_wo_gaps_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">trajectories_wo_gaps_folder</span><span class="p">,</span> <span class="s1">&#39;trajectories_wo_gaps.npy&#39;</span><span class="p">)</span>
        <span class="n">trajectories_wo_gaps</span> <span class="o">=</span> <span class="n">produce_output_dict</span><span class="p">(</span><span class="n">list_of_blobs_no_gaps</span><span class="o">.</span><span class="n">blobs_in_video</span><span class="p">,</span> <span class="n">video</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">trajectories_wo_gaps_file</span><span class="p">,</span> <span class="n">trajectories_wo_gaps</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving trajectories&quot;</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_has_trajectories_wo_gaps</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">video</span><span class="o">.</span><span class="n">_has_trajectories_wo_gaps</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">video</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">video</span><span class="o">.</span><span class="n">generate_trajectories_wogaps_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">video</span><span class="o">.</span><span class="n">generate_trajectories_wogaps_time</span>
    <span class="c1"># except Exception as e:</span>
    <span class="c1">#     exc_type, exc_obj, exc_tb = sys.exc_info()</span>
    <span class="c1">#     fname = os.path.split(exc_tb.tb_frame.f_code.co_filename)[1]</span>
    <span class="c1">#     print(exc_type, fname, exc_tb.tb_lineno)</span>
    <span class="c1">#     if old_video is not None:</span>
    <span class="c1">#         video = old_video</span>
    <span class="c1">#         video.save()</span>
</pre></div>

          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2018, Champalimaud Center for the Unknown.
      </li>
      <li>
      Last updated on Feb 07, 2018.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.6.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>