<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>get_portraits &mdash; idtrackerai 0.0.1 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../_static/scipy.css" type="text/css" >
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/copybutton.js"></script>
    <link rel="index" title="Index" href="../genindex.html" >
    <link rel="search" title="Search" href="../search.html" >
    <link rel="top" title="idtrackerai 0.0.1 documentation" href="../index.html" >
    <link rel="up" title="Module code" href="index.html" > 
  </head>
  <body>

<div class="container">
  <div class="top-scipy-org-logo-header">
    <a href="../index.html">
      <img style="border: 0;" alt="idtrackerai" src="../_static/img/idtracker_logo.gif"></a>
    </div>
  </div>
</div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
        <li class="active"><a href="http://www.idtracker.ai">idtracker.ai</a></li>
        <li class="active"><a href="http://www.gitlab.com/polaviejalab/idtracker">GitLab</a></li>
	
        <li class="active"><a href="../index.html">idtrackerai 0.0.1 documentation</a></li>
	
          <li class="active"><a href="index.html" accesskey="U">Module code</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  <h1>Source code for get_portraits</h1><div class="highlight"><pre>
<span></span><span class="c1"># Import standard libraries</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># Import third party libraries</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="k">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="k">import</span> <span class="n">PCA</span>

<span class="c1"># Import application/library specifics</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;IdTrackerDeep/utils&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">py_utils</span> <span class="k">import</span> <span class="n">loadFile</span><span class="p">,</span> <span class="n">saveFile</span>
<span class="kn">from</span> <span class="nn">video_utils</span> <span class="k">import</span> <span class="n">cntBB2Full</span><span class="p">,</span> <span class="n">full2BoundingBox</span>

<span class="kn">from</span> <span class="nn">fishcontour</span> <span class="k">import</span> <span class="n">FishContour</span>

<div class="viewcode-block" id="full2miniframe"><a class="viewcode-back" href="../index.html#get_portraits.full2miniframe">[docs]</a><span class="k">def</span> <span class="nf">full2miniframe</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">boundingBox</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Push a point in the fullframe to miniframe coordinate system.</span>
<span class="sd">    Here it is use for centroids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">boundingBox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">boundingBox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]))</span></div>

<div class="viewcode-block" id="getEncompassingIndices"><a class="viewcode-back" href="../index.html#get_portraits.getEncompassingIndices">[docs]</a><span class="k">def</span> <span class="nf">getEncompassingIndices</span><span class="p">(</span><span class="n">frameIndices</span><span class="p">,</span> <span class="n">num_segmnent</span><span class="p">,</span> <span class="n">goodIndices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    frameIndices = dataframe containing the list of frame per segment</span>
<span class="sd">    num_segment</span>
<span class="sd">    goodIndices = indices in which the permutation is defined (non-crossing and overlapping)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">frameSegment</span> <span class="o">=</span> <span class="n">frameIndices</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">frameIndices</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">num_segmnent</span><span class="p">]</span>
    <span class="n">goodFrameIndices</span> <span class="o">=</span> <span class="n">frameSegment</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">goodIndices</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">goodFrameIndices</span><span class="p">,</span> <span class="n">frameSegment</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div>

<div class="viewcode-block" id="getMFandC"><a class="viewcode-back" href="../index.html#get_portraits.getMFandC">[docs]</a><span class="k">def</span> <span class="nf">getMFandC</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">frameIndices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    path: path to dataframe</span>
<span class="sd">    generate a list of arrays containing miniframes and centroids detected in</span>
<span class="sd">    path at this point we can already discard miniframes that does not belong</span>
<span class="sd">    to a specific fragments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get number of segment</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">numSegment</span> <span class="o">=</span> <span class="n">loadFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;segmentation&#39;</span><span class="p">)</span>
    <span class="c1"># check if permutations are NaN (i.e. the frame is not included in a fragment)</span>
    <span class="n">permutationsBool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;permutation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>

    <span class="c1">#generate a lists of &quot;admissible&quot; miniframes and centroids</span>
    <span class="n">permutations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;permutation&#39;</span><span class="p">])</span>
    <span class="n">boundingBoxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;boundingBoxes&#39;</span><span class="p">])</span>
    <span class="n">miniframes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;miniFrames&#39;</span><span class="p">])</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;centroids&#39;</span><span class="p">])</span>
    <span class="n">bkgSamples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;bkgSamples&#39;</span><span class="p">])</span>

    <span class="n">goodIndices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">permutationsBool</span><span class="o">==</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">goodFrameIndices</span><span class="p">,</span> <span class="n">segmentIndices</span> <span class="o">=</span> <span class="n">getEncompassingIndices</span><span class="p">(</span><span class="n">frameIndices</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">numSegment</span><span class="p">),</span> <span class="n">goodIndices</span><span class="p">)</span>
    <span class="n">goodFrameIndices</span> <span class="o">=</span> <span class="n">segmentIndices</span>

    <span class="k">return</span> <span class="n">boundingBoxes</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">miniframes</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">centroids</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">bkgSamples</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">goodFrameIndices</span><span class="p">,</span> <span class="n">segmentIndices</span><span class="p">,</span> <span class="n">permutations</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div>

<div class="viewcode-block" id="cropPortrait"><a class="viewcode-back" href="../index.html#get_portraits.cropPortrait">[docs]</a><span class="k">def</span> <span class="nf">cropPortrait</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">identificationImageSize</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot; Given a portait it crops it in a shape (identificationImageSize,identificationImageSize) with</span>
<span class="sd">    a shift in the rows and columns given by the variable shifts. The size of</span>
<span class="sd">    the portait must be bigger than</span>

<span class="sd">    :param portrait: portrait to be cropped, usually of shape (36x36)</span>
<span class="sd">    :param identificationImageSize: size of the new portrait, usually 32, since the network accepts images of 32x32  pixels</span>
<span class="sd">    :param shift: (x,y) displacement when cropping, it can only go from -maxShift to +maxShift</span>
<span class="sd">    :return</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">currentSize</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">currentSize</span> <span class="o">&lt;</span> <span class="n">identificationImageSize</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The size of the input portrait must be bigger than identificationImageSize&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">currentSize</span> <span class="o">==</span> <span class="n">identificationImageSize</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span>
    <span class="k">elif</span> <span class="n">currentSize</span> <span class="o">&gt;</span> <span class="n">identificationImageSize</span><span class="p">:</span>
        <span class="n">maxShift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">currentSize</span> <span class="o">-</span> <span class="n">identificationImageSize</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxShift</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The shift when cropping the portrait cannot be bigger than (currentSize - identificationImageSize)/2&#39;</span><span class="p">)</span>
        <span class="n">croppedPortrait</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">maxShift</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">currentSize</span> <span class="o">-</span> <span class="n">maxShift</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">maxShift</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">currentSize</span> <span class="o">-</span> <span class="n">maxShift</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="c1"># print &#39;Portrait cropped&#39;</span>
        <span class="k">return</span> <span class="n">croppedPortrait</span></div>

<div class="viewcode-block" id="get_portrait"><a class="viewcode-back" href="../index.html#get_portraits.get_portrait">[docs]</a><span class="k">def</span> <span class="nf">get_portrait</span><span class="p">(</span><span class="n">miniframe</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">identification_image_size</span><span class="p">,</span> <span class="n">px_nose_above_center</span> <span class="o">=</span> <span class="mi">9</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Acquiring portraits from miniframe (for fish)</span>

<span class="sd">    Given a miniframe (i.e. a minimal rectangular image containing an animal)</span>
<span class="sd">    it returns a 36x36 image centered on the head.</span>

<span class="sd">    :param miniframe: A numpy 2-dimensional array</span>
<span class="sd">    :param cnt: A cv2-style contour, i.e. (x,:,y)</span>
<span class="sd">    :param bb: Coordinates of the left-top corner of miniframe in the big frame</span>
<span class="sd">    :param identification_image_size: size of the portrait (input image to cnn)</span>
<span class="sd">    :param px_nose_above_center: Number of pixels of nose above the center of portrait</span>
<span class="sd">    :return a smaller 2-dimensional array, and a tuple with all the nose coordinates in frame reference</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extra parameters</span>
    <span class="n">half_side_sq</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">identification_image_size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">overhead</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">half_side_sq</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">half_side_sq</span><span class="o">+</span><span class="n">px_nose_above_center</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="c1"># Extra pixels when performing rotation, around sqrt(half_side_sq**2 + (half_side_sq+px_nose_above_center)**2)</span>

    <span class="c1"># Calculating nose coordinates in the full frame reference</span>
    <span class="n">contour_cnt</span> <span class="o">=</span> <span class="n">FishContour</span><span class="o">.</span><span class="n">fromcv2contour</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
    <span class="n">noseFull</span><span class="p">,</span> <span class="n">rot_ang</span><span class="p">,</span> <span class="n">head_centroid_full</span> <span class="o">=</span> <span class="n">contour_cnt</span><span class="o">.</span><span class="n">find_nose_and_orientation</span><span class="p">()</span>

    <span class="c1"># Calculating nose coordinates in miniframe reference</span>
    <span class="n">nose</span> <span class="o">=</span> <span class="n">full2miniframe</span><span class="p">(</span><span class="n">noseFull</span><span class="p">,</span><span class="n">bb</span><span class="p">)</span> <span class="c1">#Float</span>
    <span class="n">nose_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">nose</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">nose</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span> <span class="c1">#int</span>

    <span class="c1"># Get roto-translation matrix and rotated miniframe</span>
    <span class="c1"># Rotation is performed around nose, nose coordinates stay constant</span>
    <span class="c1"># Final image gives an overhead above the nose coordinates, so the whole head should</span>
    <span class="c1"># stay visible in the final frame.</span>
    <span class="c1"># borderMode=cv2.BORDER_WRAP determines how source image is extended when needed</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getRotationMatrix2D</span><span class="p">(</span><span class="n">nose</span><span class="p">,</span> <span class="n">rot_ang</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">minif_rot</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">miniframe</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">nose_pixels</span><span class="o">+</span><span class="n">overhead</span><span class="p">),</span> <span class="n">borderMode</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_WRAP</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_CUBIC</span><span class="p">)</span>

    <span class="c1"># Crop the image in 32x32 frame around the nose</span>
    <span class="n">x_range</span> <span class="o">=</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nose_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">half_side_sq</span><span class="p">,</span><span class="n">nose_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">half_side_sq</span><span class="p">)</span>
    <span class="n">y_range</span> <span class="o">=</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nose_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">half_side_sq</span><span class="o">+</span><span class="n">px_nose_above_center</span><span class="p">,</span><span class="n">nose_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">half_side_sq</span><span class="o">+</span><span class="n">px_nose_above_center</span><span class="p">)</span>
    <span class="n">portrait</span> <span class="o">=</span> <span class="n">minif_rot</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">y_range</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wrap&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wrap&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">portrait</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">noseFull</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">head_centroid_full</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">))</span> <span class="c1">#output as float because it is better for analysis.</span></div>

<div class="viewcode-block" id="get_body"><a class="viewcode-back" href="../index.html#get_portraits.get_body">[docs]</a><span class="k">def</span> <span class="nf">get_body</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">miniframe</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">identificationImageSize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Acquiring portraits from miniframe (for flies)</span>
<span class="sd">    :param miniframe: A numpy 2-dimensional array</span>
<span class="sd">    :param cnt: A cv2-style contour, i.e. (x,:,y)</span>
<span class="sd">    :param bb: Coordinates of the left-top corner of miniframe in the big frame</span>
<span class="sd">    :param maximum_body_length: maximum body length of the blobs. It will be the size of the width and the height of the frame feed it to the CNN</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">miniframe</span> <span class="o">=</span> <span class="n">only_blob_pixels</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">miniframe</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">bb</span><span class="p">)</span>
    <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span>
    <span class="n">pxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">pixels</span><span class="p">,(</span><span class="n">height</span><span class="p">,</span><span class="n">width</span><span class="p">))</span>
    <span class="n">pxs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">pxs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pxs</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pxs1</span><span class="p">)</span>
    <span class="n">rot_ang</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="mi">45</span> <span class="c1"># we substract 45 so that the fish is aligned in the diagonal. This say we have smaller frames</span>
    <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">mean_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pca</span><span class="o">.</span><span class="n">mean_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># print(&quot;PCA center before: &quot;, center)</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">full2miniframe</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">bb</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
    <span class="c1"># print(&quot;PCA center and angle: &quot;, center, rot_ang)</span>

    <span class="c1">#rotate</span>
    <span class="n">diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">miniframe</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">diag</span> <span class="o">=</span> <span class="p">(</span><span class="n">diag</span><span class="p">,</span> <span class="n">diag</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getRotationMatrix2D</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">center</span><span class="p">),</span> <span class="n">rot_ang</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">minif_rot</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">miniframe</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">diag</span><span class="p">,</span> <span class="n">borderMode</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_CUBIC</span><span class="p">)</span>


    <span class="n">crop_distance</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">identificationImageSize</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">x_range</span> <span class="o">=</span> <span class="n">xrange</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">crop_distance</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">crop_distance</span><span class="p">)</span>
    <span class="n">y_range</span> <span class="o">=</span> <span class="n">xrange</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">crop_distance</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">crop_distance</span><span class="p">)</span>
    <span class="n">portrait</span> <span class="o">=</span> <span class="n">minif_rot</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">y_range</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;wrap&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;wrap&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">portrait</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">rot_ang_rad</span> <span class="o">=</span> <span class="n">rot_ang</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>
    <span class="n">h_or_t_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rot_ang_rad</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rot_ang_rad</span><span class="p">)])</span> <span class="o">*</span> <span class="n">rot_ang_rad</span>
    <span class="n">h_or_t_2</span> <span class="o">=</span> <span class="o">-</span> <span class="n">h_or_t_1</span>
    <span class="c1"># print(h_or_t_1,h_or_t_2,portrait.shape)</span>
    <span class="k">return</span> <span class="n">portrait</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">h_or_t_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">h_or_t_2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">))</span></div>

<span class="k">def</span> <span class="nf">only_blob_pixels</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">miniframe</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">bb</span><span class="p">):</span>
    <span class="n">pxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">pixels</span><span class="p">,(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">pxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pxs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">pxs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">temp_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">miniframe</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
    <span class="n">temp_image</span><span class="p">[</span><span class="n">pxs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">pxs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]]</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="n">temp_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">temp_image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">),</span> <span class="n">iterations</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">temp_image</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">dilated_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="p">])</span>

    <span class="n">temp_image</span><span class="p">[</span><span class="n">dilated_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">dilated_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]]</span> <span class="o">=</span> <span class="n">miniframe</span><span class="p">[</span><span class="n">dilated_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">dilated_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]]</span>
    <span class="k">return</span> <span class="n">temp_image</span>


<span class="k">def</span> <span class="nf">reaper</span><span class="p">(</span><span class="n">videoPath</span><span class="p">,</span> <span class="n">frameIndices</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
    <span class="c1"># only function called from idTrackerDeepGUI</span>
    <span class="nb">print</span> <span class="s1">&#39;reaping&#39;</span><span class="p">,</span> <span class="n">videoPath</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">numSegment</span> <span class="o">=</span> <span class="n">loadFile</span><span class="p">(</span><span class="n">videoPath</span><span class="p">,</span> <span class="s1">&#39;segmentation&#39;</span><span class="p">)</span>

    <span class="n">boundingboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;boundingBoxes&#39;</span><span class="p">])</span> <span class="c1">#coordinate in the frame</span>
    <span class="n">miniframes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;miniFrames&#39;</span><span class="p">])</span> <span class="c1">#image containing the blob, same size</span>
    <span class="n">miniframes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">miniframes</span><span class="p">)</span>
    <span class="n">contours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;contours&#39;</span><span class="p">])</span>
    <span class="n">centroidsSegment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;centroids&#39;</span><span class="p">])</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;pixels&#39;</span><span class="p">])</span>
    <span class="n">areasSegment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;areas&#39;</span><span class="p">])</span>

    <span class="n">segmentIndices</span> <span class="o">=</span> <span class="n">frameIndices</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">frameIndices</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span><span class="o">==</span><span class="nb">int</span><span class="p">(</span><span class="n">numSegment</span><span class="p">)]</span>
    <span class="n">segmentIndices</span> <span class="o">=</span> <span class="n">segmentIndices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="sd">&quot;&quot;&quot; Visualise &quot;&quot;&quot;</span>
    <span class="n">AllPortraits</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">segmentIndices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;portraits&#39;</span><span class="p">])</span>
    <span class="n">AllBodies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">segmentIndices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bodies&#39;</span><span class="p">])</span>
    <span class="n">AllBodyBlobs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">segmentIndices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bodyblobs&#39;</span><span class="p">])</span>
    <span class="n">AllNoses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">segmentIndices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;noses&#39;</span><span class="p">])</span>
    <span class="n">AllCentroids</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">segmentIndices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;centroids&#39;</span><span class="p">])</span>
    <span class="n">AllHeadCentroids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">segmentIndices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;head_centroids&#39;</span><span class="p">])</span>
    <span class="n">AllAreas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">segmentIndices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;areas&#39;</span><span class="p">])</span>

    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">miniframes</span><span class="p">):</span>
        <span class="n">portraits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bodies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bodyblobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">noses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">head_centroids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">areas</span> <span class="o">=</span> <span class="n">areasSegment</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>
        <span class="n">bbs</span> <span class="o">=</span> <span class="n">boundingboxes</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>
        <span class="n">minif</span> <span class="o">=</span> <span class="n">miniframes</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>
        <span class="n">cnts</span> <span class="o">=</span> <span class="n">contours</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>
        <span class="n">centroids</span> <span class="o">=</span> <span class="n">centroidsSegment</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>
        <span class="n">pxs</span> <span class="o">=</span> <span class="n">pixels</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">miniframe</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">minif</span><span class="p">):</span>
            <span class="c1">### Uncomment to plot</span>
            <span class="c1"># cv2.imshow(&#39;frame&#39;, miniframe)</span>
            <span class="c1"># cv2.waitKey()</span>

            <span class="n">identificationImageSize</span> <span class="o">=</span> <span class="mi">36</span>
            <span class="n">portrait</span><span class="p">,</span> <span class="n">nose_pixels</span><span class="p">,</span> <span class="n">head_centroid_pixels</span> <span class="o">=</span> <span class="n">get_portrait</span><span class="p">(</span><span class="n">miniframe</span><span class="p">,</span><span class="n">cnts</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">bbs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">identificationImageSize</span><span class="p">)</span>
            <span class="n">portraits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">portrait</span><span class="p">)</span>
            <span class="n">noses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nose_pixels</span><span class="p">)</span>
            <span class="n">head_centroids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head_centroid_pixels</span><span class="p">)</span>

            <span class="n">identificationImageSize</span> <span class="o">=</span> <span class="mi">52</span>
            <span class="n">body</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_body</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">miniframe</span><span class="p">,</span> <span class="n">pxs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">bbs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">identificationImageSize</span><span class="p">,</span> <span class="n">only_blob</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">bodies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

            <span class="n">bodyblob</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_body</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">miniframe</span><span class="p">,</span> <span class="n">pxs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">bbs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">identificationImageSize</span><span class="p">,</span> <span class="n">only_blob</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">bodyblobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bodyblob</span><span class="p">)</span>


        <span class="n">AllPortraits</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">segmentIndices</span><span class="p">[</span><span class="n">counter</span><span class="p">],</span> <span class="s1">&#39;portraits&#39;</span><span class="p">,</span> <span class="n">portraits</span><span class="p">)</span>
        <span class="n">AllBodies</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">segmentIndices</span><span class="p">[</span><span class="n">counter</span><span class="p">],</span> <span class="s1">&#39;bodies&#39;</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>
        <span class="n">AllBodyBlobs</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">segmentIndices</span><span class="p">[</span><span class="n">counter</span><span class="p">],</span> <span class="s1">&#39;bodyblobs&#39;</span><span class="p">,</span> <span class="n">bodyblobs</span><span class="p">)</span>
        <span class="n">AllNoses</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">segmentIndices</span><span class="p">[</span><span class="n">counter</span><span class="p">],</span> <span class="s1">&#39;noses&#39;</span><span class="p">,</span> <span class="n">noses</span><span class="p">)</span>
        <span class="n">AllHeadCentroids</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">segmentIndices</span><span class="p">[</span><span class="n">counter</span><span class="p">],</span> <span class="s1">&#39;head_centroids&#39;</span><span class="p">,</span> <span class="n">head_centroids</span><span class="p">)</span>
        <span class="n">AllCentroids</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">segmentIndices</span><span class="p">[</span><span class="n">counter</span><span class="p">],</span> <span class="s1">&#39;centroids&#39;</span><span class="p">,</span> <span class="n">centroids</span><span class="p">)</span>
        <span class="n">AllAreas</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">segmentIndices</span><span class="p">[</span><span class="n">counter</span><span class="p">],</span> <span class="s1">&#39;areas&#39;</span><span class="p">,</span> <span class="n">areas</span><span class="p">)</span>

        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span> <span class="s1">&#39;you just reaped&#39;</span><span class="p">,</span> <span class="n">videoPath</span>
    <span class="k">return</span> <span class="n">AllPortraits</span><span class="p">,</span> <span class="n">AllBodies</span><span class="p">,</span> <span class="n">AllBodyBlobs</span><span class="p">,</span> <span class="n">AllNoses</span><span class="p">,</span> <span class="n">AllHeadCentroids</span><span class="p">,</span> <span class="n">AllCentroids</span><span class="p">,</span> <span class="n">AllAreas</span>

<span class="k">def</span> <span class="nf">portrait</span><span class="p">(</span><span class="n">videoPaths</span><span class="p">,</span> <span class="n">dfGlobal</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
    <span class="n">frameIndices</span> <span class="o">=</span> <span class="n">loadFile</span><span class="p">(</span><span class="n">videoPaths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;frameIndices&#39;</span><span class="p">)</span>
    <span class="n">num_cores</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
    <span class="c1"># num_cores = 1</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">num_cores</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">reaper</span><span class="p">)(</span><span class="n">videoPath</span><span class="p">,</span> <span class="n">frameIndices</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="k">for</span> <span class="n">videoPath</span> <span class="ow">in</span> <span class="n">videoPaths</span><span class="p">)</span>
    <span class="n">allPortraits</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]</span>
    <span class="n">allPortraits</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">allPortraits</span><span class="p">)</span>
    <span class="n">allPortraits</span> <span class="o">=</span> <span class="n">allPortraits</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">allBodies</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]</span>
    <span class="n">allBodies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">allBodies</span><span class="p">)</span>
    <span class="n">allBodies</span> <span class="o">=</span> <span class="n">allBodies</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">allBodyBlobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]</span>
    <span class="n">allBodyBlobs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">allBodyBlobs</span><span class="p">)</span>
    <span class="n">allBodyBlobs</span> <span class="o">=</span> <span class="n">allBodyBlobs</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">allNoses</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]</span>
    <span class="n">allNoses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">allNoses</span><span class="p">)</span>
    <span class="n">allNoses</span> <span class="o">=</span> <span class="n">allNoses</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">allHeadCentroids</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]</span>
    <span class="n">allHeadCentroids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">allHeadCentroids</span><span class="p">)</span>
    <span class="n">allHeadCentroids</span> <span class="o">=</span> <span class="n">allHeadCentroids</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">allCentroids</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]</span>
    <span class="n">allCentroids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">allCentroids</span><span class="p">)</span>
    <span class="n">allCentroids</span> <span class="o">=</span> <span class="n">allCentroids</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">allAreas</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]</span>
    <span class="n">allAreas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">allAreas</span><span class="p">)</span>
    <span class="n">allAreas</span> <span class="o">=</span> <span class="n">allAreas</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">allPortraits</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dfGlobal</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The list of indexes in allPortraits and dfGlobal should be the same&#39;</span><span class="p">)</span>
    <span class="c1"># dfGlobal1 = pd.DataFrame(index = range(len(dfGlobal)), columns=[&#39;images&#39;])</span>
    <span class="n">dfGlobal</span><span class="p">[</span><span class="s1">&#39;identities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfGlobal</span><span class="p">[</span><span class="s1">&#39;permutations&#39;</span><span class="p">]</span>
    <span class="n">dfGlobal</span><span class="p">[</span><span class="s1">&#39;portraits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allPortraits</span>
    <span class="n">dfGlobal</span><span class="p">[</span><span class="s1">&#39;bodies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allBodies</span>
    <span class="n">dfGlobal</span><span class="p">[</span><span class="s1">&#39;bodyblobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allBodyBlobs</span>
    <span class="n">dfGlobal</span><span class="p">[</span><span class="s1">&#39;noses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allNoses</span>
    <span class="n">dfGlobal</span><span class="p">[</span><span class="s1">&#39;head_centroids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allHeadCentroids</span>
    <span class="n">dfGlobal</span><span class="p">[</span><span class="s1">&#39;centroids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allCentroids</span>
    <span class="n">dfGlobal</span><span class="p">[</span><span class="s1">&#39;areas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allAreas</span>

    <span class="n">saveFile</span><span class="p">(</span><span class="n">videoPaths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dfGlobal</span><span class="p">,</span> <span class="s1">&#39;portraits&#39;</span><span class="p">,</span><span class="n">hdfpkl</span><span class="o">=</span><span class="s1">&#39;pkl&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dfGlobal</span>
</pre></div>

          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2018, Mattia G. Bergomi, Francisco Romero Ferrero.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.6.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>